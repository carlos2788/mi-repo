
# azure-pipelines.scripts.yml

trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  NUGET_PACKAGES: '$(Pipeline.Workspace)/.nuget/packages'

steps:
- checkout: self
  displayName: 'Checkout repo'

- task: UseDotNet@2
  displayName: 'Instalar .NET SDK 10.x'
  inputs:
    packageType: 'sdk'
    version: '10.0.100'

# Diagnóstico
- script: dotnet --info
  displayName: '.NET info'
- script: dotnet --list-sdks
  displayName: 'SDKs instalados'

# Preparar carpeta de caché
- script: mkdir -p '$(NUGET_PACKAGES)'
  displayName: 'Crear carpeta NuGet en workspace'

# Cache NuGet
- task: Cache@2
  displayName: 'Cache NuGet (packages)'
  inputs:
    key: 'nuget | "$(Agent.OS)" | **/packages.lock.json, **/*.csproj, **/*.fsproj, **/*.vbproj'
    restoreKeys: |
      nuget | "$(Agent.OS)"
    path: '$(NUGET_PACKAGES)'

# Restore (usando la carpeta cacheada)
- script: dotnet restore MiApp.slnx
  displayName: 'Restore (.slnx)'
  workingDirectory: '$(Build.SourcesDirectory)'
  env:
    NUGET_PACKAGES: '$(NUGET_PACKAGES)'

# Build
- script: dotnet build MiApp.slnx -c Release --no-restore
  displayName: 'Build (.slnx)'
  workingDirectory: '$(Build.SourcesDirectory)'
  env:
    NUGET_PACKAGES: '$(NUGET_PACKAGES)'

# Test (proyecto vacío: permitir continuar)
- script: dotnet test MiApp.Tests/MiApp.Tests.csproj -c Release --no-build
  displayName: 'Test (permitir continuar si está vacío)'
  workingDirectory: '$(Build.SourcesDirectory)'
  continueOnError: true
  env:
    NUGET_PACKAGES: '$(NUGET_PACKAGES)'

# (Opcional) Publish
# - script: dotnet publish MiApp.slnx -c Release -o $(Build.ArtifactStagingDirectory) --no-build
#   displayName: 'Publish'
#   workingDirectory: '$(Build.SourcesDirectory)'
#   env:
#     NUGET_PACKAGES: '$(NUGET_PACKAGES)'
# - publish: $(Build.ArtifactStagingDirectory)
#   artifact: drop
